name: Sync to Alibaba Cloud OSS

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Debug - List repository files
      run: |
        echo "=== ä»“åº“æ–‡ä»¶åˆ—è¡¨ ==="
        find . -type f | head -20
        echo "=== å½“å‰ç›®å½• ==="
        pwd
        ls -la

    - name: Install and Configure ossutil
      env:
        ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
        ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
        OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
        OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
      run: |
        echo "å¼€å§‹å®‰è£…å’Œé…ç½® ossutil..."
        
        # ä¸‹è½½å¹¶å®‰è£… ossutil
        wget -q https://gosspublic.alicdn.com/ossutil/v2/2.1.2/ossutil-2.1.2-linux-amd64.zip
        unzip -q ossutil-2.1.2-linux-amd64.zip
        sudo mv ossutil-2.1.2-linux-amd64/ossutil /usr/local/bin/ossutil
        chmod +x /usr/local/bin/ossutil
        
        # é…ç½® ossutil - ç§»é™¤äº†æœ‰é—®é¢˜çš„ -L å‚æ•°
        echo "é…ç½® OSS Endpoint: $OSS_ENDPOINT"
        echo "é…ç½® OSS Bucket: $OSS_BUCKET"
        ossutil config -e $OSS_ENDPOINT -i $ACCESS_KEY_ID -k $ACCESS_KEY_SECRET
        
        # éªŒè¯é…ç½®
        echo "éªŒè¯ OSS è¿æ¥..."
        ossutil ls oss://$OSS_BUCKET/ || echo "Bucket åˆ—è¡¨å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

    - name: Sync Files to OSS
      env:
        OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
      run: |
        echo "å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ° OSS..."
        # é¦–æ¬¡åŒæ­¥ï¼Œå…ˆä¸ä½¿ç”¨ --delete å‚æ•°
        ossutil sync ./ oss://$OSS_BUCKET/ -u
        echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆï¼"
        echo "ğŸ‰ å¯é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼šhttps://$OSS_BUCKET.${{ secrets.OSS_ENDPOINT }}"