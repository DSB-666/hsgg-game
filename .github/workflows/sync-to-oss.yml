name: Sync to Alibaba Cloud OSS

on:
  push:
    branches: [ master ] # è®¾ç½®ä¸ºéœ€è¦åœ¨å“ªä¸ªåˆ†æ”¯æ¨é€æ—¶è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # æ­¤å¤„å¯ä»¥æ·»åŠ ä½ çš„æ„å»ºæ­¥éª¤ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œä¾‹å¦‚ä½¿ç”¨ npm run build
    # - name: Build Project
    #   run: |
    #     npm install
    #     npm run build

    - name: Configure ossutil
      env:
        # é€šè¿‡ GitHub Secrets é…ç½®çš„ AccessKey å’Œ OSS ä¿¡æ¯
        ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
        ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
        OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
        OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
      run: |
        # ä¸‹è½½ ossutil
        wget https://gosspublic.alicdn.com/ossutil/v2/2.1.2/ossutil-2.1.2-linux-amd64.zip
        unzip ossutil-2.1.2-linux-amd64.zip
        sudo mv ossutil-2.1.2-linux-amd64/ossutil /usr/local/bin/ossutil
        chmod +x /usr/local/bin/ossutil

        # ä½¿ç”¨å¯†é’¥é…ç½® ossutil
        ossutil config -e $OSS_ENDPOINT -i $ACCESS_KEY_ID -k $ACCESS_KEY_SECRET -L CH
        
        # éªŒè¯é…ç½®æ˜¯å¦æˆåŠŸ
        echo "éªŒè¯ OSS è¿æ¥å’Œ Bucket è®¿é—®æƒé™..."
        ossutil ls oss://$OSS_BUCKET/

    - name: Sync Files to OSS
      env:
        OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
      run: |
        # åŒæ­¥æ–‡ä»¶åˆ°ä½ çš„ OSS Bucket
        echo "å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ° OSS Bucket: $OSS_BUCKET"
        ossutil sync ./ oss://$OSS_BUCKET/ -u --delete
        
        # åŒæ­¥å®Œæˆåæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        echo "ğŸ‰ æ–‡ä»¶åŒæ­¥å®Œæˆï¼"
