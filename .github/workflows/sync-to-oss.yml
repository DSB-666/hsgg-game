name: Sync to Alibaba Cloud OSS

on:
  push:
    branches: [ main, master ]  # 同时监听 main 和 master 分支

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Debug - List repository files
      run: |
        echo "=== 仓库文件列表 ==="
        find . -type f | head -20
        echo "=== 当前目录 ==="
        pwd
        ls -la

    - name: Install and Configure ossutil
      env:
        ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
        ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
        OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
        OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
      run: |
        echo "开始安装和配置 ossutil..."
        
        # 下载并安装 ossutil
        wget -q https://gosspublic.alicdn.com/ossutil/v2/2.1.2/ossutil-2.1.2-linux-amd64.zip
        unzip -q ossutil-2.1.2-linux-amd64.zip
        sudo mv ossutil-2.1.2-linux-amd64/ossutil /usr/local/bin/ossutil
        chmod +x /usr/local/bin/ossutil
        
        # 配置 ossutil
        echo "配置 OSS Endpoint: $OSS_ENDPOINT"
        echo "配置 OSS Bucket: $OSS_BUCKET"
        ossutil config -e $OSS_ENDPOINT -i $ACCESS_KEY_ID -k $ACCESS_KEY_SECRET -L CH
        
        # 验证配置
        echo "验证 OSS 连接..."
        ossutil ls oss://$OSS_BUCKET/ || echo "Bucket 列表失败，但继续执行"

    - name: Sync Files to OSS
      env:
        OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
      run: |
        echo "开始同步文件到 OSS..."
        # 首次同步，先不使用 --delete 参数
        ossutil sync ./ oss://$OSS_BUCKET/ -u
        echo "✅ 文件同步完成！"