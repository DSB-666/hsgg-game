<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邪恶大马斯特的百宝库</title>
    <link rel="stylesheet" href="CSS/styles.css">
    </head>
    <body>
    <!-- 场景叠层：雾与浮动光球 -->
    <div class="scene-overlay" aria-hidden="true">
        <div class="fog"></div>
        <div class="float-orb one"></div>
        <div class="float-orb two small"></div>
        <div class="float-orb three"></div>
        <div class="float-orb four small"></div>
    </div>
    <!-- 左右路灯（来自 双生魔丸.html） -->
    <div class="street-light-left" aria-hidden="true">
        <div class="light-base"></div>
        <div class="light-pole"></div>
        <div class="light-arm"></div>
        <div class="light-head">
            <div class="light-glow"></div>
            <div class="rope"></div>
            <div class="hanged-figure">邪恶大马斯特刘</div>
        </div>
    </div>

    <div class="street-light-right" aria-hidden="true">
        <div class="light-base"></div>
        <div class="light-pole"></div>
        <div class="light-arm"></div>
        <div class="light-head">
            <div class="light-glow"></div>
            <div class="rope"></div>
            <div class="hanged-figure">邪恶大马斯特刘</div>
        </div>
    </div>
    <header>
        <h1 id="siteTitle" class="title">邪恶大马斯特的百宝库</h1>
        <p id="siteSubtitle" class="subtitle">踏入此地者，将直面无尽游戏的诱惑</p>
        <!-- 顶部微粒子（SVG，纯装饰） -->
        <svg class="header-particles" width="100%" height="100%" viewBox="0 0 800 120" preserveAspectRatio="none" aria-hidden="true">
            <defs>
                <linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#ff6a00" stop-opacity="0.12"/><stop offset="1" stop-color="#8b0000" stop-opacity="0.06"/></linearGradient>
            </defs>
            <path d="M0,80 C150,10 350,140 800,40 L800,120 L0,120 Z" fill="url(#g1)"></path>
        </svg>
    </header>

    <div class="container">
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="在宝库中搜寻游戏...">
            </div>
            <div class="filter-buttons" id="filterButtons">
                <button class="filter-btn active" data-filter="all">全部游戏</button>
                <button class="filter-btn" data-filter="action">动作</button>
                <button class="filter-btn" data-filter="adventure">冒险</button>
                <button class="filter-btn" data-filter="strategy">策略</button>
                <button class="filter-btn" data-filter="puzzle">解谜</button>
            </div>
        </div>

        <div class="games-grid" id="gamesContainer">
            <!-- 游戏卡片将通过JavaScript动态生成 -->
        </div>
    </div>

    <footer>
        <p>邪恶大马斯特的百宝库 &copy; 2023 - 踏入此地者，永无回头之路</p>
    </footer>

    <script>
        // 优先从仓库根部的 games.json 加载（可由脚本生成）。若加载失败则回退到内置示例数据。
        const fallbackGames = [
            //{ id:1, title:'成都超人', description:'成都超人', category:'action', folder:'成都超人', players:'单人', difficulty:'中等', link:'./Game/成都超人/index.html', image:'./Game/成都超人/TemplateData/style.css' },
            //{ id:2, title:'吃豆包人', description:'吃豆包人', category:'adventure', folder:'吃豆包人', players:'单人', difficulty:'中等', link:'./Game/吃豆包人/index.html', image:'./Game/吃豆包人/Build/吃豆包人.loader.js' },
            { id:1, title:'成都超人', description:'成都超人', category:'action', folder:'成都超人', players:'单人', difficulty:'中等', link:'./Game/成都超人/index.html', image:'./Game/成都超人/preview.png' },
            { id:2, title:'吃豆包人', description:'吃豆包人', category:'adventure', folder:'吃豆包人', players:'单人', difficulty:'中等', link:'./Game/吃豆包人/index.html', image:'./Game/吃豆包人/preview.png' },
            { id:3, title:'黑神话像素版', description:'像素化版本演示', category:'adventure', folder:'黑神话像素版', players:'单人', difficulty:'中等', link:'./Game/黑神话像素版/index.html', image:'./Game/黑神话像素版/preview.png' },
            { id:4, title:'哈基米南北绿豆', description:'哈基米南北绿豆', category:'adventure', folder:'哈基米南北绿豆', players:'单人', difficulty:'中等', link:'./Game/哈基米南北绿豆/index.html', image:'./Game/哈基米南北绿豆/preview.png' }
        ];

        // 从 games.json 拉取数据（如果存在）
        async function loadGames() {
            try {
                        const resp = await fetch('./games.json', { cache: 'no-store' });
                        if (!resp.ok) throw new Error('no games.json');
                        const data = await resp.json();
                        if (!Array.isArray(data) || data.length === 0) throw new Error('empty');
                        return data.map((g, idx) => ({ id: g.id || idx+1, title: g.title || g.name || g.folder, description: g.description || '', category: g.category || 'other', folder: g.folder || g.name || '', link: g.link || (`./Game/${g.folder || g.name}/index.html`), image: g.image || g.preview || g.thumb || '' }));
            } catch (e) {
                        console.warn('加载 games.json 失败：', e);
                        // 尝试抓取 Game 目录的列表（如果静态服务器允许目录索引）
                        try {
                            const dirResp = await fetch('./Game/');
                            if (dirResp.ok) {
                                const text = await dirResp.text();
                                // 提取 href="NAME/" 或 href='NAME/' 的目录名
                                const re = /href\s*=\s*["']([^"']+)\/["']/g;
                                const folders = new Set();
                                let m;
                                while ((m = re.exec(text)) !== null) {
                                    const name = m[1];
                                    if (name === '../') continue;
                                    // 只添加顶层文件夹名（不包含 path）
                                    if (!name.includes('/')) folders.add(decodeURIComponent(name));
                                }
                                const arr = Array.from(folders).map((name, idx) => ({
                                    id: idx+1,
                                    title: name,
                                    description: '',
                                    category: 'other',
                                    folder: name,
                                    link: `./Game/${encodeURIComponent(name)}/index.html`,
                                    image: `./Game/${encodeURIComponent(name)}/preview.png`
                                }));
                                if (arr.length) return arr;
                            }
                        } catch (err) {
                            console.warn('尝试读取 Game 目录列表失败：', err);
                        }
                        // 最后回退到内置数据
                        console.warn('使用回退数据');
                        return fallbackGames;
            }
        }

                // 将标题/副标题拆分为单字符并添加动效（参考 双生魔丸）
                function splitText(element) {
                    if (!element) return;
                    const text = element.textContent.trim();
                    element.innerHTML = '';
                    for (let i = 0; i < text.length; i++) {
                        const container = document.createElement('span');
                        container.className = 'char-container';
                        container.style.setProperty('--rotate-duration', (Math.random()*6+6).toFixed(1)+'s');

                        const char = document.createElement('span');
                        char.className = 'char';
                        char.textContent = text[i];
                        char.style.setProperty('--i', i);
                        char.style.setProperty('--duration', (Math.random()*2+2).toFixed(1)+'s');
                        char.style.setProperty('--shake-duration', (Math.random()*1+1).toFixed(1)+'s');

                        // small staggered animations
                        char.style.animation = `breath ${ (Math.random()*2+2).toFixed(1) }s ease-in-out infinite, flow ${ (Math.random()*4+4).toFixed(1) }s linear infinite, shake ${ (Math.random()*1+1).toFixed(1) }s ease-in-out infinite`;

                        container.appendChild(char);
                        element.appendChild(container);
                    }
                }

        // 渲染游戏卡片
        function renderGames(gamesToRender) {
            const container = document.getElementById('gamesContainer');
            container.innerHTML = '';
            if (!gamesToRender || gamesToRender.length === 0) {
                container.innerHTML = '<div class="no-results">未找到匹配的游戏...大马斯特的宝库中似乎没有你要找的东西</div>';
                return;
            }

            gamesToRender.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card';
                gameCard.setAttribute('data-category', game.category || 'other');

                // 选择合适的图片或占位
                // 优先尝试：Game/<folder>/preview.png -> game.image -> 占位SVG
                let imgTag = '';
                const folderName = game.folder || '';
                const previewPath = folderName ? (`./Game/${encodeURIComponent(folderName)}/preview.png`) : null;
                const label = escapeHtml(game.title || game.folder || '游戏');
                const placeholderSvg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='600' height='360'><rect fill='#4a0000' width='600' height='360'/><text x='50%' y='50%' font-family='Arial' font-size='28' fill='#ffffff' dominant-baseline='middle' text-anchor='middle'>${label}</text></svg>`);
                const placeholderData = `data:image/svg+xml;utf8,${placeholderSvg}`;

                if (previewPath) {
                    // 先尝试目录下的 preview.png，失败后回退到 game.image 或占位
                    const imageSrc = previewPath;
                    // 使用 onerror 切换到 game.image（若存在）或占位图
                    const fallback = (game.image && typeof game.image === 'string') ? escapeAttr(game.image) : placeholderData;
                    imgTag = `<img src="${imageSrc}" alt="${label}" onerror="this.onerror=null;this.src='${fallback}'">`;
                } else if (game.image && typeof game.image === 'string') {
                    imgTag = `<img src="${escapeAttr(game.image)}" alt="${label}" onerror="this.onerror=null;this.src='${placeholderData}'">`;
                } else {
                    imgTag = `<img src='${placeholderData}' alt='${label}'>`;
                }

                gameCard.innerHTML = `
                    <div class="game-image">${imgTag}</div>
                    <div class="game-info">
                        <h3 class="game-title">${escapeHtml(game.title)}</h3>
                        <p class="game-description">${escapeHtml(game.description || '')}</p>
                        <a href="${escapeAttr(game.link)}" class="play-btn" target="_self">进入游戏</a>
                    </div>
                `;

                container.appendChild(gameCard);
            });
        }

        function escapeHtml(s){ return String(s || '').replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
        function escapeAttr(s){ return String(s || '').replace(/"/g,'&quot;'); }

        // 搜索与筛选
        function attachControls(games) {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', e => {
                const term = e.target.value.toLowerCase().trim();
                const filtered = games.filter(g => (g.title||'').toLowerCase().includes(term) || (g.description||'').toLowerCase().includes(term));
                renderGames(filtered);
            });

            document.getElementById('filterButtons').addEventListener('click', e => {
                const btn = e.target.closest('.filter-btn');
                if (!btn) return;
                document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                const filter = btn.getAttribute('data-filter');
                if (filter === 'all') renderGames(games);
                else renderGames(games.filter(g => (g.category||'').toLowerCase() === filter.toLowerCase()));
            });
        }

        // 启动
        (async function(){
            const games = await loadGames();
            renderGames(games);
            attachControls(games);
        })();
    </script>
</body>
</html>